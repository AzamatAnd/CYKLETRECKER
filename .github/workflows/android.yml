name: 🚀 Ultra Modern Android CI/CD 2025

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [published]

permissions:
  contents: write

env:
  ANDROID_SDK_VERSION: 35
  ANDROID_BUILD_TOOLS_VERSION: 35.0.0
  JAVA_VERSION: 17
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  # Quality checks before build
  quality:
    name: 🔍 Code Quality & Tests
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: 🔧 Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: 🔍 Run linting
        run: ./gradlew lintDebug lintRelease --continue

      - name: 🧪 Run unit tests
        run: ./gradlew testDebugUnitTest testReleaseUnitTest

      - name: 📱 Run instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          profile: Nexus 6
          script: ./gradlew connectedDebugAndroidTest

      - name: 📊 Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            app/build/reports/tests/
            app/build/reports/lint/
          retention-days: 30

      - name: ❌ Check for linting errors
        run: |
          if [ -f "app/build/reports/lint/lintDebug.html" ]; then
            echo "🔍 Linting completed - check uploaded reports for details"
          fi

  # Main build job
  build:
    name: 🏗️ Build APK & AAB
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      matrix:
        build-type: [debug, release]
        include:
          - build-type: debug
            gradle-task: assembleDebug
          - build-type: release
            gradle-task: assembleRelease

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: 🔧 Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: 🔑 Decode signing key (Release only)
        if: matrix.build-type == 'release'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          echo "KEYSTORE_FILE=keystore.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: 🚀 Build ${{ matrix.build-type }} APK
        run: ./gradlew ${{ matrix.gradle-task }}

      - name: 📦 Upload ${{ matrix.build-type }} APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.build-type }}-apk
          path: |
            app/build/outputs/apk/${{ matrix.build-type }}/*.apk
            app/build/outputs/bundle/${{ matrix.build-type }}/*.aab
          retention-days: 90

      - name: 📊 Generate build info
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Build type: ${{ matrix.build-type }}" >> build-info.txt
          echo "Git commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref }}" >> build-info.txt

      - name: 📤 Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.build-type }}
          path: build-info.txt
          retention-days: 30

  # Deploy to GitHub Releases
  deploy:
    name: 🚀 Deploy to Releases
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: 📥 Download release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: ./release-artifacts/

      - name: 🚀 Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./release-artifacts/*.apk
            ./release-artifacts/*.aab
          body: |
            # 🚀 Ultra Modern Cycle Tracker 2025

            **Автоматически собранный релиз** версии ${{ github.ref_name }}

            ## ✨ Новые функции:
            - 🥽 **VR/AR интеграция** - 3D визуализация цикла
            - ⛓️ **Блокчейн здоровье** - децентрализованные данные
            - 🤖 **AI функции** - интеллектуальный анализ
            - 🎨 **Ultra-modern дизайн** - анимированные интерфейсы
            - ⚡ **Быстрая навигация** - свайпы и жесты

            ## 🛠️ Технические улучшения:
            - **Kotlin + Jetpack Compose** - современная архитектура
            - **Room Database** - надежное хранение данных
            - **Material 3** - актуальный дизайн
            - **Оптимизированная сборка** - быстрая загрузка

            ## 📱 Требования:
            - Android 8.0+ (API 26+)
            - Камера (для AR функций)
            - Интернет (для блокчейн операций)

            ---
            *Собрано с помощью GitHub Actions CI/CD 2025*
          draft: false
          prerelease: false

  # Summary job
  summary:
    name: 📋 Build Summary
    runs-on: ubuntu-latest
    needs: [quality, build, deploy]
    if: always()

    steps:
      - name: 📊 Generate summary
        run: |
          echo "## 🚀 Build Summary" > summary.md
          echo "" >> summary.md
          echo "| Job | Status |" >> summary.md
          echo "|-----|--------|" >> summary.md
          echo "| 🔍 Quality Checks | ${{ needs.quality.result }} |" >> summary.md
          echo "| 🏗️ Build | ${{ needs.build.result }} |" >> summary.md
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "| 🚀 Deploy | ${{ needs.deploy.result }} |" >> summary.md
          fi
          echo "" >> summary.md
          echo "Build completed at $(date)" >> summary.md

      - name: 📤 Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: summary.md

