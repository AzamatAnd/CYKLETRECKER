name: ğŸš€ Ultra Modern Android CI/CD 2025

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [published]

permissions:
  contents: write

env:
  ANDROID_SDK_VERSION: 35
  ANDROID_BUILD_TOOLS_VERSION: 35.0.0
  JAVA_VERSION: 17
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  # Quality checks before build
  quality:
    name: ğŸ” Code Quality & Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ” Run linting
        run: ./gradlew lintDebug lintRelease --continue

      - name: ğŸ§ª Run unit tests
        run: ./gradlew testDebugUnitTest testReleaseUnitTest

      - name: ğŸ“± Run instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          profile: Nexus 6
          script: ./gradlew connectedDebugAndroidTest

      - name: ğŸ“Š Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            app/build/reports/tests/
            app/build/reports/lint/
          retention-days: 30

      - name: âŒ Check for linting errors
        run: |
          if [ -f "app/build/reports/lint/lintDebug.html" ]; then
            echo "ğŸ” Linting completed - check uploaded reports for details"
          fi

  # Main build job
  build:
    name: ğŸ—ï¸ Build APK & AAB
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      matrix:
        build-type: [debug, release]
        include:
          - build-type: debug
            gradle-task: assembleDebug
          - build-type: release
            gradle-task: assembleRelease

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ”‘ Decode signing key (Release only)
        if: matrix.build-type == 'release'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          echo "KEYSTORE_FILE=keystore.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: ğŸš€ Build ${{ matrix.build-type }} APK
        run: ./gradlew ${{ matrix.gradle-task }}

      - name: ğŸ“¦ Upload ${{ matrix.build-type }} APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.build-type }}-apk
          path: |
            app/build/outputs/apk/${{ matrix.build-type }}/*.apk
            app/build/outputs/bundle/${{ matrix.build-type }}/*.aab
          retention-days: 90

      - name: ğŸ“Š Generate build info
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Build type: ${{ matrix.build-type }}" >> build-info.txt
          echo "Git commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref }}" >> build-info.txt

      - name: ğŸ“¤ Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.build-type }}
          path: build-info.txt
          retention-days: 30

  # Deploy to GitHub Releases
  deploy:
    name: ğŸš€ Deploy to Releases
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: ğŸ“¥ Download release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: ./release-artifacts/

      - name: ğŸš€ Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./release-artifacts/*.apk
            ./release-artifacts/*.aab
          body: |
            # ğŸš€ Ultra Modern Cycle Tracker 2025

            **ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ·** Ğ²ĞµÑ€ÑĞ¸Ğ¸ ${{ github.ref_name }}

            ## âœ¨ ĞĞ¾Ğ²Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:
            - ğŸ¥½ **VR/AR Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ** - 3D Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ†Ğ¸ĞºĞ»Ğ°
            - â›“ï¸ **Ğ‘Ğ»Ğ¾ĞºÑ‡ĞµĞ¹Ğ½ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ** - Ğ´ĞµÑ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            - ğŸ¤– **AI Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸** - Ğ¸Ğ½Ñ‚ĞµĞ»Ğ»ĞµĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·
            - ğŸ¨ **Ultra-modern Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½** - Ğ°Ğ½Ğ¸Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹
            - âš¡ **Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ** - ÑĞ²Ğ°Ğ¹Ğ¿Ñ‹ Ğ¸ Ğ¶ĞµÑÑ‚Ñ‹

            ## ğŸ› ï¸ Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ:
            - **Kotlin + Jetpack Compose** - ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
            - **Room Database** - Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            - **Material 3** - Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½
            - **ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°** - Ğ±Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°

            ## ğŸ“± Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
            - Android 8.0+ (API 26+)
            - ĞšĞ°Ğ¼ĞµÑ€Ğ° (Ğ´Ğ»Ñ AR Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹)
            - Ğ˜Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚ (Ğ´Ğ»Ñ Ğ±Ğ»Ğ¾ĞºÑ‡ĞµĞ¹Ğ½ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹)

            ---
            *Ğ¡Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ GitHub Actions CI/CD 2025*
          draft: false
          prerelease: false

  # Summary job
  summary:
    name: ğŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [quality, build, deploy]
    if: always()

    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "## ğŸš€ Build Summary" > summary.md
          echo "" >> summary.md
          echo "| Job | Status |" >> summary.md
          echo "|-----|--------|" >> summary.md
          echo "| ğŸ” Quality Checks | ${{ needs.quality.result }} |" >> summary.md
          echo "| ğŸ—ï¸ Build | ${{ needs.build.result }} |" >> summary.md
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "| ğŸš€ Deploy | ${{ needs.deploy.result }} |" >> summary.md
          fi
          echo "" >> summary.md
          echo "Build completed at $(date)" >> summary.md

      - name: ğŸ“¤ Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: summary.md

